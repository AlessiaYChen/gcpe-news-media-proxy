# Media Proxy (Gov.News.Meida.Website)
	This is MVC Core web service intended to provide proxying and caching of external image resources. It also includes functionality to create embeded html from provided resource ids to improve clients privacy.

## Api usage
	
	The web service is to be hosted at media.news.gov.bc.ca. The following GET only web api end points are available: 
		-/proxy  
		-/embed/youtube
		-/embed/facebook
		-/embed/soundcloud
		
	[Proxy]
		
		Query:
			- /proxy?url={external_image_resource_url}  
			The "url" parameter must be a valid encoded HTTPS url with the host name being a subdomain of the following list ("youtube.com", "staticflickr.com", "twimg.com", "fbcdn.net").

		Http Responses:
			- 200 (Success) - Returns an image with the content-type header set to the type returned by the external resource.
			- 400 (Bad request) - Malformatted or unspported Url.
			- 403 (Forbidden) - Access is not allowed by the client because Referer header is not set to allowed Host. If EnableRefererHeaderFilter is enabled (must be in Prod) the proxy server will check if the Referer request header matches the white listed host.
			- 415 (Unsupported Media Type) - The requested resource content-type is not allowed by the proxy server.
			- 502 (Bad gateway) - The external url points to non-existing content.
			- 503 (Service Unavailable) - The server runs in downgraded mode and only serves images from Cache. If the image is not in Cache this error code is returned.
			- 500 (Service Failure) - Possible causes: IO error when caching images, malformatted config file or internal application error.

		Examples:
			- Youtube image:  https://media.news.gov.bc.ca/proxy?url=https%3a%2f%2fimg.youtube.com%2fvi%2fsTUOyC0sfao%2f0.jpg
			- Facebook image: https://media.news.gov.bc.ca/proxy?url=https%3A%2F%2Fscontent.xx.fbcdn.net%2Fhphotos-xpl1%2Fv%2Ft1.0-9%2Fs720x720%2F12745478_1145286798822944_72500271216888786_n.jpg%3Foh%3D45c7a5b0d00d81930839890a433c6fe9%26oe%3D57506623
			- Flickr image:	  https://media.news.gov.bc.ca/proxy?url=https%3a%2f%2ffarm2.staticflickr.com%2f1506%2f24597275629_8b61814578_b.jpg


	[Embed]

		Query:
			- /embed/youtube?id={youtube_id}&autoplay=[true|false]
			- /embed/facebook?id={facebook_id_path}&autoplay=[true|false]
			- /embed/soundcloud?id={soudncloud_id}&autoplay=[true|false]
			- The "id" string parameter must be encoded. The "autoplay" is an optional parameter defaulting to false.
			
		Http Responses:
			- 200 (Success) - Returns "text\html" content-type MIME type and html to be embeded in the client.
			- 403 (Forbidden) - Access is not allowed by the client because Referer is not set to allowed Host. If EnableRefererHeaderFilter is enabled (must be in Production) the proxy server will check if the Referer request header matches the white listed host.
			- 500 (Service Failure) - Possible causes: IO error when caching images, malformatted config file or internal error.

		Examples:
			- Youtube:	  https://media.news.gov.bc.ca/embed/youtube?id=ywTR5IyHmzI&autoplay=true
			- Facebook:	  https://media.news.gov.bc.ca/embed/facebook?id=BCProvincialGovernment%2Fvideos%2F1155829311102026
			- Soundcloud: https://media.news.gov.bc.ca/proxy?id=237141367	


## Security	
	The web service has been implemented to minimize risk of malicious intervention or MITM attacks. The following list of preventive measures is intended to mitigate potential breaches.
		
	- Only GET verbs and specified in the api section end points are available to retrieve data
	- Only HTTPS url parameter is allowed
	- Hashing of cached images filenames is implemented to avoid potential problems with local directories traversal and unauthorized access of local files
	- Only restricted domains ("youtube.com", "staticflickr.com", "twimg.com", "fbcdn.net") and content types ("image/jpeg", "image/png", "image/gif") are allowed
	- "Referer" request header is checked for every request to verify the client is authorized to access this web service
	- Log file tracks record of errors or attempts of unauthorized access

## Encryption/Decryption
	
	- HMAC-SHA256 hash token is generated by using a standard RFC2104 definition


## Configuration

    "Settings": {

		//Local cache folder path
        "AssetsCacheFolder": "..\\..\\Cache", 

		//List of allowed subdomains for the proxy url
        "AllowedHosts": [ "youtube.com", "staticflickr.com", "twimg.com", "fbcdn.net", "gov.bc.ca" ],

		//List of allowed Mime types to get from the external servers
        "AllowedContentType": [ "image/jpeg", "image/png", "image/gif" ],

		//If the external resource request did not return success code its response is cached for this duration. Requests with this originally faulty url will only be retried after expiration.
        "InvalidRequestRetryHours": 72,

		//Enables the use if Referer request header filter
        "EnableRefererHeaderFilter": true,

		//List of alloed domains in the Referer request header
        "RefererAllowedDomains": [ "dev.news.gov.bc.ca", "test.news.gov.bc.ca", "uat.news.gov.bc.ca", "news.gov.bc.ca" ],

		//Enables signature check mode for the proxy url parameter. If disbled the proxy will not verify the token.
		"EnableCryptoMode": true,

		//List of Base64 encoded keys to try to generate hash for the url token verification. Normal operation is only one key, but can put several keys temporarily if needed.
        "PasswordKeys": [ "put your base64 key here" ]
    },
    }

    "Logging": {
		//Local log file
        "LogFile":  "..\\..\\Log Files\\ProxyLog.log"
    }

This and other documentation could also be available at J drive here \\SFP.IDIR.BCGOV\S124\S24113\SID - BCS\Application Development\Media Proxy